{
  "project_id": "ai_search_lite",
  "created": "2026-02-09",
  "description": "Refactoring ai-search-lite: 17K-line PHP monolith → modular architecture. AI-powered educational resource recommender for Hebrew math teachers.",
  "source_path": "C:\\Users\\User\\Desktop\\ai-search-lite_8",
  "stack": "PHP 7.2, MySQL/SQLite, OpenAI GPT-4o, vanilla JS",
  "production_url": "https://www.yisumatica.org.il/",
  "constraint": "Live in production. Must remain functional after every change.",
  "template_used": "jobs/refactorer",
  "agents": {
    "auditor": {
      "role": "Codebase Auditor",
      "description": "Maps the entire codebase: file structure, function locations, data flow, anti-patterns, traps.",
      "config": {
        "max_findings": 200,
        "phase": 0,
        "depends_on": null,
        "source_file": "index.php",
        "total_lines": 17138
      },
      "experience": {
        "run_count": 1,
        "last_run": "2026-02-09",
        "status": "complete",
        "completed_at": "2026-02-09T10:00:00",
        "file_map": {
          "index.php": {
            "lines": 17138,
            "content": "ALL backend PHP + HTML + CSS + JS in one file",
            "sections": {
              "early_ajax_handler": [
                1,
                173
              ],
              "php_db_functions": [
                174,
                761
              ],
              "php_config_topics": [
                762,
                830
              ],
              "php_sorting": [
                831,
                900
              ],
              "php_keyword_matching": [
                2703,
                2860
              ],
              "php_data_loaders": [
                2880,
                3170
              ],
              "php_scoring_grading": [
                3170,
                3700
              ],
              "php_openai_topic_detect": [
                3701,
                3830
              ],
              "php_image_url_builder": [
                3931,
                4246
              ],
              "php_ai_recommendation_core": [
                4247,
                5104
              ],
              "php_openai_wrapper": [
                5105,
                5244
              ],
              "php_caching_corrections": [
                5245,
                6126
              ],
              "php_overrides": [
                6127,
                6345
              ],
              "php_url_builders": [
                6346,
                6659
              ],
              "php_ai_selection": [
                6660,
                8280
              ],
              "html_template": [
                8282,
                9600
              ],
              "js_logging_version": [
                9600,
                9890
              ],
              "js_category_toggle": [
                9890,
                10100
              ],
              "js_user_lessons": [
                10100,
                10800
              ],
              "js_group_lessons": [
                10800,
                11200
              ],
              "js_php_embedded_cards": [
                11200,
                12700
              ],
              "js_utils_icons": [
                12700,
                13100
              ],
              "js_auth_schools": [
                13100,
                13400
              ],
              "js_student_link": [
                13400,
                13600
              ],
              "js_student_link_ui": [
                13600,
                14100
              ],
              "js_card_builder": [
                14100,
                15200
              ],
              "js_modals_handlers": [
                15200,
                15700
              ],
              "js_search_tags_requests": [
                15700,
                16600
              ],
              "js_autocomplete": [
                16600,
                17138
              ]
            }
          },
          "setup_databases.php": {
            "lines": 266,
            "purpose": "table creation utility"
          },
          "view_lesson_entries.php": {
            "lines": 380,
            "purpose": "lesson analytics viewer"
          },
          "gpt_api_example.php": {
            "lines": 234,
            "purpose": "standalone OpenAI examples"
          },
          "extractor.py": {
            "lines": 180,
            "purpose": "Python data extraction"
          },
          "worksheets.json": {
            "purpose": "worksheet catalog, ~20KB"
          }
        },
        "external_dependencies": [
          {
            "file": "config.php",
            "note": "DB config constants, NOT in repo, in parent dirs"
          },
          {
            "file": "connect.php",
            "note": "Creates $connection (mysqli), searched in 5 paths at lines 246-252"
          },
          {
            "file": "helpers.php",
            "note": "Shared functions. SHADOW RISK: defines submitTeacherRequest, index.php also defines it at line 498"
          }
        ],
        "function_index": {
          "getMysqlCorrectionsConnection": {
            "line": 236,
            "category": "db"
          },
          "getFeedbackDb": {
            "line": 208,
            "category": "db"
          },
          "storeFeedbackSuggestion": {
            "line": 222,
            "category": "db"
          },
          "storeTeacherMessage": {
            "line": 279,
            "category": "db"
          },
          "getTeacherConversation": {
            "line": 315,
            "category": "db"
          },
          "trackTopicSearch": {
            "line": 364,
            "category": "tracking"
          },
          "trackAppOpen": {
            "line": 427,
            "category": "tracking"
          },
          "submitTeacherRequest": {
            "line": 498,
            "category": "requests"
          },
          "supportTeacherRequest": {
            "line": 562,
            "category": "requests"
          },
          "getTeacherRequests": {
            "line": 676,
            "category": "requests"
          },
          "sortCatalogEntries": {
            "line": 831,
            "category": "recommendations"
          },
          "normalizeKeyword": {
            "line": 2703,
            "category": "recommendations"
          },
          "extractAndNormalizeKeywords": {
            "line": 2762,
            "category": "recommendations"
          },
          "doesItemContainKeyword": {
            "line": 2807,
            "category": "recommendations"
          },
          "detectStrongKeyword": {
            "line": 2859,
            "category": "recommendations"
          },
          "loadYisumaticaApps": {
            "line": 2880,
            "category": "data_loaders"
          },
          "loadYisumaticaLessons": {
            "line": 2949,
            "category": "data_loaders"
          },
          "loadKehilaLessons": {
            "line": 3002,
            "category": "data_loaders"
          },
          "loadWorksheetCatalog": {
            "line": 3061,
            "category": "data_loaders"
          },
          "loadTotalLikes": {
            "line": 3134,
            "category": "data_loaders"
          },
          "loadYisumaticaPuzzles": {
            "line": 3170,
            "category": "data_loaders"
          },
          "buildAppImageUrl": {
            "line": 3931,
            "category": "url_builders"
          },
          "getAppIdentifier": {
            "line": 4247,
            "category": "url_builders"
          },
          "buildStructuredAppSummaries": {
            "line": 4299,
            "category": "openai"
          },
          "buildLessonSuggestionSummary": {
            "line": 4330,
            "category": "openai"
          },
          "callOpenAIChatCompletion": {
            "line": 5105,
            "category": "openai"
          },
          "trackTokenUsage": {
            "line": 5138,
            "category": "openai"
          },
          "findCachedResponse": {
            "line": 5245,
            "category": "corrections"
          },
          "ensureAiCorrectionsColumns": {
            "line": 5373,
            "category": "corrections"
          },
          "storeAiCorrection": {
            "line": 5411,
            "category": "corrections"
          },
          "fetchAiCorrections": {
            "line": 5937,
            "category": "corrections"
          },
          "fetchRecommendationOverrides": {
            "line": 6127,
            "category": "corrections"
          },
          "applyRecommendationOverrides": {
            "line": 6232,
            "category": "corrections"
          },
          "storeRecommendationOverride": {
            "line": 6272,
            "category": "corrections"
          },
          "buildYoutubeUrl": {
            "line": 6346,
            "category": "url_builders"
          },
          "buildPuzzleSiteUrl": {
            "line": 6377,
            "category": "url_builders"
          },
          "buildPuzzleContentUrl": {
            "line": 6399,
            "category": "url_builders"
          },
          "buildAppUrl": {
            "line": 6433,
            "category": "url_builders"
          },
          "mapSourceMetaFromItem": {
            "line": 3259,
            "category": "url_builders"
          },
          "callOpenAIForSelection": {
            "line": 6660,
            "category": "openai"
          },
          "extractTextFromResponse": {
            "line": 8260,
            "category": "openai"
          }
        },
        "db_tables": [
          "ai_corrections",
          "ai_teacher_conversations",
          "ai_recommendation_overrides",
          "ai_teacher_requests",
          "ai_usage_tracking",
          "ai_feedback"
        ],
        "external_apis": [
          "POST yisumaticaApi/getApps.php",
          "POST yisumaticaApi/getLessons.php",
          "GET yisumaticaApiZvi/getKehilaLessons.php",
          "POST yisumaticaApi/getTotalLikes.php",
          "POST yisumaticaApi/getPuzzles.php",
          "POST yisumaticaApi/getUserLessons.php",
          "POST api.openai.com/v1/chat/completions"
        ],
        "findings": [
          {
            "timestamp": "2026-02-09T10:00:00",
            "category": "shadow_risk",
            "problem": "helpers.php and index.php both define submitTeacherRequest()",
            "solution": "Verify which definition wins before extracting. Test early AJAX handler separately.",
            "context": "index.php:84,175,498",
            "engine": "claude-opus-4-6"
          },
          {
            "timestamp": "2026-02-09T10:00:01",
            "category": "load_bearing_hack",
            "problem": "ob_start() at line 4 prevents HTML leaking into AJAX JSON responses",
            "solution": "Do NOT remove until AJAX is fully separated into its own file",
            "context": "index.php:4",
            "engine": "claude-opus-4-6"
          },
          {
            "timestamp": "2026-02-09T10:00:02",
            "category": "data_flow",
            "problem": "PHP -> HTML data-attributes -> JS. JS display bugs traced to PHP source not JS consumer.",
            "solution": "When extracting JS, PHP-injected data must move to data-* attrs or global var block",
            "context": "lines 11200-12700 contain <?php echo ?> inside <script> blocks",
            "engine": "claude-opus-4-6"
          },
          {
            "timestamp": "2026-02-09T10:00:03",
            "category": "duplication_bug",
            "problem": "buildAppImageUrl logic exists in both PHP (line 3931) and JS (~line 17000). Already caused bugs.",
            "solution": "REMOVE JS-side image URL logic during frontend extraction. Rely on PHP-computed imageUrl.",
            "context": "requests.md documents this as known bug source",
            "engine": "claude-opus-4-6"
          },
          {
            "timestamp": "2026-02-09T10:00:04",
            "category": "auth_pattern",
            "problem": "Authentication is client-side only. Lines 188-195 set empty vars. JS checkSignIn() does real auth.",
            "solution": "Do not introduce server-side auth. This is intentional.",
            "context": "index.php:188-195, JS ~line 12859",
            "engine": "claude-opus-4-6"
          },
          {
            "timestamp": "2026-02-09T10:00:05",
            "category": "session_pattern",
            "problem": "No PHP sessions used. teacher_session_id is a raw cookie, 30-day expiry.",
            "solution": "Do not call session_start(). Cookie-based ID is intentional.",
            "context": "index.php:200-205",
            "engine": "claude-opus-4-6"
          },
          {
            "timestamp": "2026-02-09T10:00:06",
            "category": "path_sensitivity",
            "problem": "connect.php searched in 5 paths because app deploys at different relative positions",
            "solution": ".env approach eliminates this. Ensure .env is discoverable from any deploy path.",
            "context": "index.php:246-252",
            "engine": "claude-opus-4-6"
          },
          {
            "timestamp": "2026-02-09T10:00:07",
            "category": "duplication_pattern",
            "problem": "Every DB function has full MySQL impl then full SQLite impl (~12 functions, ~1500 lines)",
            "solution": "Database abstraction class. Highest-impact single change for the entire refactoring.",
            "context": "trackTopicSearch, trackAppOpen, submitTeacherRequest, supportTeacherRequest, getTeacherRequests, storeTeacherMessage, getTeacherConversation, etc.",
            "engine": "claude-opus-4-6"
          },
          {
            "timestamp": "2026-02-09T10:00:08",
            "category": "duplication_pattern",
            "problem": "escapeHtml() defined 4+ times in separate <script> blocks",
            "solution": "Extract to single utils.js",
            "context": "JS at ~12712, ~14074, ~16432, ~16943",
            "engine": "claude-opus-4-6"
          },
          {
            "timestamp": "2026-02-09T10:00:09",
            "category": "noise",
            "problem": "Category toggle section has ~80 console.log lines for simple expand/collapse",
            "solution": "Remove all but error-level logging when extracting",
            "context": "index.php:9724-9858",
            "engine": "claude-opus-4-6"
          },
          {
            "timestamp": "2026-02-09T10:00:10",
            "category": "runtime_ddl",
            "problem": "CREATE TABLE IF NOT EXISTS called inside tracking functions at runtime",
            "solution": "Remove from runtime functions. setup_databases.php already handles this.",
            "context": "trackTopicSearch:374, trackAppOpen:443, submitTeacherRequest:508",
            "engine": "claude-opus-4-6"
          },
          {
            "timestamp": "2026-02-09T10:00:11",
            "category": "security_positive",
            "problem": "No hardcoded passwords or API keys anywhere in repo. Prepared statements used consistently.",
            "solution": "Maintain this standard. All secrets via .env only.",
            "context": "verified across all .php files",
            "engine": "claude-opus-4-6"
          },
          {
            "timestamp": "2026-02-09T17:30:00",
            "category": "dependency_analysis",
            "problem": "helpers.php is required at line 175 but may be a phantom dependency — all called functions exist in index.php",
            "solution": "helpers.php can be an empty stub for local dev. In production it may provide submitTeacherRequest() which shadows index.php:498. Needs verification on the live server.",
            "context": "Analyzed all function calls in lines 1-800 against definitions in full 17K-line file. Zero unique functions from helpers.php identified.",
            "engine": "claude-opus-4-6"
          },
          {
            "timestamp": "2026-02-09T17:30:01",
            "category": "architecture_insight",
            "problem": "The SQLite fallback path is fully functional — site was designed to work without MySQL",
            "solution": "For local dev and testing: just let connect.php be missing. getMysqlCorrectionsConnection() returns null, all DB functions fall through to SQLite. This is load-bearing design, not a bug.",
            "context": "getMysqlCorrectionsConnection at line 236 has static caching + null fallback pattern",
            "engine": "claude-opus-4-6"
          }
        ]
      }
    },
    "db_architect": {
      "role": "Database Layer Architect",
      "description": "Creates unified Database class wrapping MySQL+SQLite. Creates .env config. Eliminates all dual-implementation DB functions.",
      "config": {
        "max_findings": 100,
        "phase": 1,
        "depends_on": "auditor",
        "target_files": [
          "config/.env",
          "config/env_loader.php",
          "includes/Database.php",
          "includes/db_functions.php"
        ],
        "estimated_lines_removed": 1500,
        "recall_types": [
          "shadow_risk",
          "load_bearing_hack",
          "path_sensitivity",
          "duplication_pattern",
          "runtime_ddl"
        ]
      },
      "experience": {
        "run_count": 0,
        "status": "pending",
        "files_created": [],
        "lines_removed": 0,
        "findings": []
      }
    },
    "backend_splitter": {
      "role": "PHP Module Extractor",
      "description": "Extracts PHP functions from index.php into includes/. Creates separate AJAX handler.",
      "config": {
        "max_findings": 100,
        "phase": 2,
        "depends_on": "db_architect",
        "extraction_plan": {
          "includes/data_loaders.php": {
            "category": "data_loaders",
            "functions": 6,
            "estimated_lines": 500
          },
          "includes/recommendations.php": {
            "category": "recommendations",
            "functions": 10,
            "estimated_lines": 1000
          },
          "includes/openai.php": {
            "category": "openai",
            "functions": 8,
            "estimated_lines": 800
          },
          "includes/corrections.php": {
            "category": "corrections",
            "functions": 9,
            "estimated_lines": 700
          },
          "includes/url_builders.php": {
            "category": "url_builders",
            "functions": 7,
            "estimated_lines": 400
          },
          "api/ajax_handler.php": {
            "note": "Extract early handler + POST routing",
            "estimated_lines": 300
          }
        },
        "recall_types": [
          "shadow_risk",
          "load_bearing_hack",
          "data_flow"
        ]
      },
      "experience": {
        "run_count": 0,
        "status": "pending",
        "files_created": [],
        "lines_removed": 0,
        "findings": []
      }
    },
    "frontend_splitter": {
      "role": "CSS and JavaScript Extractor",
      "description": "Extracts CSS to stylesheet. Splits ~7500 lines of JS into modules.",
      "config": {
        "max_findings": 100,
        "phase": 3,
        "depends_on": "backend_splitter",
        "extraction_plan": {
          "static/css/style.css": {
            "estimated_lines": 800
          },
          "static/js/utils.js": {
            "note": "Single escapeHtml, debounce, getCookie",
            "estimated_lines": 100
          },
          "static/js/cards.js": {
            "note": "REMOVE JS image URL logic",
            "estimated_lines": 200
          },
          "static/js/auth.js": {
            "estimated_lines": 300
          },
          "static/js/search.js": {
            "estimated_lines": 500
          },
          "static/js/teacher-requests.js": {
            "estimated_lines": 200
          },
          "static/js/student-link.js": {
            "estimated_lines": 300
          },
          "static/js/modals.js": {
            "estimated_lines": 100
          },
          "static/js/user-lessons.js": {
            "estimated_lines": 700
          },
          "static/js/app.js": {
            "note": "Clean category toggle debug logs",
            "estimated_lines": 500
          }
        },
        "recall_types": [
          "data_flow",
          "duplication_bug",
          "duplication_pattern",
          "noise"
        ]
      },
      "experience": {
        "run_count": 0,
        "status": "pending",
        "files_created": [],
        "lines_removed": 0,
        "findings": []
      }
    },
    "cleanup": {
      "role": "Final Cleanup",
      "description": "Removes dead code, backup files, excessive logging. Initializes git. Verifies app.",
      "config": {
        "max_findings": 50,
        "phase": 4,
        "depends_on": "frontend_splitter",
        "targets": [
          "Remove index_backup_for_dev/, index_copy_try.php, index_unknown.php",
          "Remove CREATE TABLE from runtime functions",
          "Strip excessive error_log() and console.log()",
          "Create .gitignore for .venv/, __pycache__/, .embeddings/, *.db, .env",
          "git init + initial commit in source project"
        ]
      },
      "experience": {
        "run_count": 0,
        "status": "pending",
        "files_removed": [],
        "findings": []
      }
    },
    "tester": {
      "role": "Tester",
      "description": "Verifies components work after each phase. Reads other agents' deposits to know what changed. Runs syntax checks, include chain verification, endpoint checks, and smoke test checklists. Tracks regressions across phases.",
      "config": {
        "max_findings": 150,
        "run_after_phases": [
          "db_architect",
          "backend_splitter",
          "frontend_splitter",
          "cleanup"
        ],
        "available_tools": [
          "php -l"
        ],
        "test_levels": {
          "syntax": "php -l on all changed/created .php files",
          "include_chain": "Verify all require_once/include paths resolve",
          "endpoint": "curl each AJAX action, verify JSON response (not HTML pollution)",
          "smoke": "Load main page, search, click card, submit request",
          "regression": "Re-check all previously broken things"
        },
        "ajax_actions_to_test": [
          "teacher_chat",
          "ai_summary",
          "get_teacher_requests",
          "submit_teacher_request",
          "support_teacher_request",
          "track_usage",
          "track_app_open",
          "get_group_lessons",
          "get_user_lessons",
          "fetch_corrections"
        ],
        "recall_types": [
          "test_failure",
          "regression",
          "flaky",
          "load_bearing_hack"
        ]
      },
      "experience": {
        "run_count": 0,
        "status": "pending",
        "test_results": [],
        "regressions_found": [],
        "flaky_areas": [],
        "findings": []
      }
    }
  },
    "env_setup": {
      "role": "Environment Setup",
      "description": "Installs and configures local dev tools to match production. Tracks attempts, failures, and alternatives. Production runs PHP 7.2 — must match.",
      "config": {
        "max_lessons": 200,
        "production_php_version": "7.2",
        "production_server": "Apache (shared hosting)",
        "machine": "Windows 10 x64 (19045.6466)",
        "available_package_managers": ["chocolatey_2.4.3", "winget_1.12.460"],
        "unavailable_package_managers": ["scoop"],
        "constraint": "MUST install PHP 7.x to match production. PHP 8.x has breaking changes (removed functions, changed behavior)."
      },
      "experience": {
        "run_count": 1,
        "last_run": "2026-02-09",
        "status": "complete",
        "php_path": "C:\\php7\\php-7.2.34\\php.exe",
        "installations": [
          {
            "tool": "php",
            "target_version": "7.4.33",
            "method": "curl from windows.php.net",
            "success": false,
            "duration_s": 420,
            "notes": "Direct download from windows.php.net/releases/php-7.4.33-nts-Win32-vc15-x64.zip. Extremely slow: ~3-10KB/s. Got to ~10MB of 24.9MB then timed out (exit code 56). Server throttles downloads heavily.",
            "timestamp": "2026-02-09T16:02:00",
            "engine": "claude-opus-4-6"
          },
          {
            "tool": "php",
            "target_version": "7.4.33",
            "method": "chocolatey",
            "success": false,
            "notes": "choco install php --version=7.4.33 failed. Two issues: (1) non-admin install requires different location, (2) stale lock file at C:\\ProgramData\\chocolatey\\lib\\f0d6f1557051... from previous crashed NuGet process. Need admin rights or remove lock file.",
            "timestamp": "2026-02-09T16:15:00",
            "engine": "claude-opus-4-6"
          },
          {
            "tool": "php",
            "target_version": "7.x",
            "method": "winget search",
            "success": false,
            "notes": "winget has NO PHP 7.x packages. Oldest available: PHP 8.1. winget cannot solve the PHP 7 requirement.",
            "timestamp": "2026-02-09T16:20:00",
            "engine": "claude-opus-4-6"
          },
          {
            "tool": "php",
            "target_version": "8.1.34",
            "method": "winget",
            "success": true,
            "notes": "WRONG VERSION INSTALLED. winget install PHP.PHP.NTS.8.1 succeeded (29.3MB, fast download). But production runs PHP 7.2 — PHP 8.1 has breaking changes. This was a mistake: should have respected the version constraint before installing.",
            "timestamp": "2026-02-09T16:22:00",
            "engine": "claude-opus-4-6",
            "error_type": "version_mismatch",
            "lesson": "Always check production version constraint BEFORE falling back to different version. The agent ignored the user-stated PHP 7.2 requirement."
          },
          {
            "tool": "php",
            "target_version": "7.2.34",
            "method": "curl from windows.php.net/archives",
            "success": true,
            "duration_s": 30,
            "notes": "Downloaded from archives URL (not releases). 26.1MB completed in ~30s. KEY INSIGHT: archives/ path is MUCH faster than releases/ path on windows.php.net. Extracted to C:\\php7\\php-7.2.34\\. Verified: PHP 7.2.34 (cli) NTS MSVC15 x64.",
            "timestamp": "2026-02-09T17:13:00",
            "engine": "claude-opus-4-6",
            "install_path": "C:\\php7\\php-7.2.34"
          }
        ],
        "findings": [
          {
            "timestamp": "2026-02-09T16:25:00",
            "category": "install_failure",
            "problem": "windows.php.net throttles downloads to ~3-10KB/s from this machine",
            "solution": "Use a mirror, package manager, or XAMPP bundle instead of direct download",
            "context": "24.9MB file took 7+ minutes to reach 10MB before timing out",
            "engine": "claude-opus-4-6"
          },
          {
            "timestamp": "2026-02-09T16:25:01",
            "category": "install_failure",
            "problem": "Chocolatey requires admin privileges on this machine. Lock file from previous crash blocks install.",
            "solution": "Either run as admin, or remove stale lock file at C:\\ProgramData\\chocolatey\\lib\\f0d6f1557051..., or use different package manager",
            "context": "choco v2.4.3 installed but running as non-admin user",
            "engine": "claude-opus-4-6"
          },
          {
            "timestamp": "2026-02-09T16:25:02",
            "category": "version_constraint",
            "problem": "Production runs PHP 7.2. No package manager (winget, choco, scoop) has PHP 7.x for Windows. Only PHP 8.1+ available.",
            "solution": "For PHP 7.x on Windows: (1) XAMPP with PHP 7.x bundle, (2) manual download from windows.php.net/downloads/releases/archives/, (3) use the partial download already at C:\\php\\ (10MB of 24.9MB)",
            "context": "User explicitly stated: 'the site is running on php 7.2 i think'",
            "engine": "claude-opus-4-6"
          },
          {
            "timestamp": "2026-02-09T16:25:03",
            "category": "agent_mistake",
            "problem": "Agent installed PHP 8.1 despite knowing production runs PHP 7.2. Prioritized speed over correctness.",
            "solution": "ALWAYS check version constraint before installing. If the correct version is unavailable via fast methods, document the gap and ask user — do NOT silently substitute.",
            "context": "PHP 7.2->8.1 breaks: each() removed, create_function() removed, string functions changed, type coercion stricter",
            "engine": "claude-opus-4-6"
          },
          {
            "timestamp": "2026-02-09T16:25:04",
            "category": "alternative_method",
            "problem": "Need PHP 7.x on Windows without admin and with slow windows.php.net",
            "solution": "Next attempts should try: (1) resume partial curl download with -C flag, (2) XAMPP portable 7.x, (3) download from museum.php.net or archive mirror, (4) ask user if they have PHP installer already",
            "engine": "claude-opus-4-6"
          },
          {
            "timestamp": "2026-02-09T17:13:00",
            "category": "install_success",
            "problem": "Needed PHP 7.2 on Windows. Package managers don't have it. Direct download from releases/ was throttled.",
            "solution": "Use windows.php.net/downloads/releases/archives/ (NOT /releases/). Archives path downloads at full speed (~1MB/s vs ~3KB/s from releases path). curl with --max-time 600 works fine.",
            "context": "PHP 7.2.34 NTS installed at C:\\php7\\php-7.2.34\\php.exe",
            "engine": "claude-opus-4-6"
          },
          {
            "timestamp": "2026-02-09T17:14:00",
            "category": "alternative_method",
            "problem": "4 methods failed before finding working approach for PHP 7.x on Windows",
            "solution": "Working method chain: curl + windows.php.net/downloads/releases/archives/ URL. Failed methods: direct releases URL (throttled), chocolatey (needs admin), winget (no PHP 7.x), winget PHP 8.1 (wrong version).",
            "engine": "claude-opus-4-6"
          },
          {
            "timestamp": "2026-02-09T17:45:00",
            "category": "correction",
            "problem": "Previously believed chocolatey couldn't find PHP 7.4.33 — WRONG. It has the package (approved).",
            "solution": "choco install php --version=7.4.33 WOULD work if run as admin or after removing stale lock file. The failure was permissions, not package availability. With admin rights, chocolatey is the fastest path to PHP 7.4 on Windows.",
            "context": "choco search php --version 7.4.33 returns: 'php 7.4.33 [Approved]'",
            "engine": "claude-opus-4-6"
          }
        ]
      }
    }
  },
    "dev_harness": {
      "role": "Local Dev Harness Builder",
      "description": "Creates stub files and config so the project can run locally for testing. Records what works offline vs needs the real server.",
      "config": {
        "max_lessons": 100,
        "php_path": "C:\\php7\\php-7.2.34\\php.exe",
        "php_ini_changes": [
          "extension_dir = ext (was commented out)",
          "Enabled: curl, mbstring, mysqli, openssl, pdo_mysql, pdo_sqlite, sqlite3",
          "All other extensions left at defaults"
        ],
        "server_command": "C:\\php7\\php-7.2.34\\php.exe -S localhost:8000 -t C:\\Users\\User\\Desktop\\ai-search-lite_8",
        "external_dependencies": {
          "helpers.php": {
            "status": "needs_stub",
            "analysis": "Required at line 175 and conditionally at line 84. HOWEVER: all functions called in index.php are defined IN index.php itself. helpers.php may define submitTeacherRequest() which shadows index.php line 498 definition. A minimal empty stub may suffice.",
            "stub_strategy": "Create empty helpers.php with just <?php — the site's own definitions will take over"
          },
          "connect.php": {
            "status": "needs_stub",
            "analysis": "Searched in 5 paths (line 246-252). Creates $connection (mysqli). If not found, getMysqlCorrectionsConnection() returns null and code falls back to SQLite.",
            "stub_strategy": "Don't create — let the fallback to SQLite handle it. The site is designed for this."
          },
          "openai_config.php": {
            "status": "optional",
            "analysis": "Searched in 6 paths (line 776-788). Defines OPENAI_API_KEY. Without it, AI features return empty results.",
            "stub_strategy": "Skip for now. AI features not testable without real key anyway."
          }
        },
        "offline_testable": [
          "Page loads and renders HTML/CSS",
          "Category expand/collapse (pure JS)",
          "RTL layout and Hebrew text rendering",
          "Search form submission (returns empty results without DB)",
          "PHP syntax validation of all files",
          "Include chain verification",
          "Student link UI generation (pure JS)",
          "YouTube modal (needs internet for embed)"
        ],
        "NOT_testable_offline": [
          "AI recommendations (needs OpenAI API key)",
          "DB-backed teacher requests (needs MySQL or SQLite with data)",
          "Teacher chat (needs DB)",
          "Usage tracking (needs DB)",
          "External API calls to yisumaticaApi (needs production server)",
          "Real search results (needs all data loaders + DB)"
        ]
      },
      "experience": {
        "run_count": 0,
        "status": "pending",
        "stubs_created": [],
        "gaps": [],
        "findings": [
          {
            "timestamp": "2026-02-09T17:30:00",
            "category": "harness_discovery",
            "problem": "helpers.php is required but may not actually provide any unique functions",
            "solution": "All 10+ functions called in index.php are also DEFINED in index.php. helpers.php likely provides submitTeacherRequest() which shadows index.php:498. An empty stub (just <?php) should work.",
            "context": "Verified by searching all function calls in lines 1-800 against function definitions in full file",
            "engine": "claude-opus-4-6"
          },
          {
            "timestamp": "2026-02-09T17:30:01",
            "category": "harness_discovery",
            "problem": "connect.php not found doesn't crash the site — SQLite fallback is built in",
            "solution": "Don't stub connect.php. Let getMysqlCorrectionsConnection() return null. SQLite handles everything. This is the DESIGNED fallback path.",
            "context": "index.php:236-270 — static $mysqliChecked pattern with graceful null return",
            "engine": "claude-opus-4-6"
          },
          {
            "timestamp": "2026-02-09T17:30:02",
            "category": "php_config",
            "problem": "PHP 7.2 NTS needs extensions enabled manually for this project",
            "solution": "Copy php.ini-development to php.ini. Set extension_dir=ext. Enable: curl, mbstring, mysqli, openssl, pdo_mysql, pdo_sqlite, sqlite3. All are in the ext/ folder already.",
            "context": "php.ini at C:\\php7\\php-7.2.34\\php.ini — 7 extensions uncommented",
            "engine": "claude-opus-4-6"
          },
          {
            "timestamp": "2026-02-09T17:30:03",
            "category": "process_lesson",
            "problem": "Agent was repeatedly reminded to record findings in persistent-team JSON but kept forgetting",
            "solution": "After EVERY significant discovery or action, immediately update team.json BEFORE moving to the next task. Do not batch recordings — they get lost when context compresses.",
            "engine": "claude-opus-4-6"
          }
        ]
      }
    }
  },
  "universal_knowledge": {
    "monolith_structure": "17,138-line index.php: PHP backend (1-8280), HTML (8282-9600), JS (9600-17138)",
    "data_flow": "PHP -> HTML data-attributes -> JS. Debug at PHP source.",
    "credential_status": "Already clean. No hardcoded secrets. Externalized to config.php/connect.php.",
    "hebrew_codebase": "RTL layout, Hebrew keyword normalization, Google Fonts Assistant",
    "production_php_version": "7.2 (user confirmed). Must match locally.",
    "local_machine": "Windows 10 x64, choco 2.4.3 (needs admin), winget 1.12.460, no scoop, Python 3.13.2 available"
  }
}